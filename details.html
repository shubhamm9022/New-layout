<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Movie Details</title>

  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* All your existing styles remain the same */
    
    /* Added styles for button container and download button */
    .button-container {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .btn.download-btn {
      background: linear-gradient(90deg, #2196F3, #00BCD4);
    }
    
    /* Responsive adjustments for buttons */
    @media (max-width: 480px) {
      .button-container {
        flex-direction: column;
        width: 100%;
      }
      
      .button-container .btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>

<div class="banner" id="banner">
  <div class="back-btn" id="backBtn">
    <i class="bi bi-arrow-left"></i>
  </div>
</div>

<div class="movie-container">
  <div class="poster">
    <img id="poster" src="" alt="Poster" onerror="this.src='https://via.placeholder.com/220x330?text=No+Poster'">
  </div>

  <div class="movie-details">
    <h1 class="movie-title" id="title">Loading...</h1>

    <div class="info-tags" id="mainTags"></div>

    <div class="info-tags" id="genreTags"></div>

    <div class="button-container">
      <a href="#" class="btn" id="watchBtn">WATCH NOW</a>
      <a href="#" class="btn download-btn" id="downloadBtn">DOWNLOAD</a>
    </div>

    <div class="synopsis" id="synopsisSection">
      <h2 class="synopsis-title">Synopsis</h2>
      <p class="synopsis-text" id="synopsisText">Loading...</p>
    </div>
  </div>
</div>

<!-- Similar movies -->
<div class="similar-section">
  <h2 class="similar-title">Similar Content</h2>
  <div class="similar-grid" id="similarMovies"></div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const mediaId = urlParams.get('id');
const mediaType = urlParams.get('type') || 'movie'; // Default to movie if not specified
const apiKey = 'c4064977d8835c7a9e758c7ccf25d0fa';

// Set API endpoints based on media type
const detailsUrl = mediaType === 'tv'
  ? `https://api.themoviedb.org/3/tv/${mediaId}?api_key=${apiKey}&language=en-US`
  : `https://api.themoviedb.org/3/movie/${mediaId}?api_key=${apiKey}&language=en-US`;

const similarUrl = mediaType === 'tv'
  ? `https://api.themoviedb.org/3/tv/${mediaId}/similar?api_key=${apiKey}&language=en-US&page=1`
  : `https://api.themoviedb.org/3/movie/${mediaId}/similar?api_key=${apiKey}&language=en-US&page=1`;

// Quality options matching index page
const qualityOptions = [
  { text: 'HD', class: 'hd' },
  { text: 'CAM', class: 'cam' },
  { text: 'FHD', class: 'fhd' },
  { text: '4K', class: '_4k' }
];

// Star image URL matching index page
const starImageUrl = 'https://i.postimg.cc/ZqbHmT4p/1000133487-removebg-preview-1.png';

// Back button functionality
document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = 'index.html';
});

// Function to load content from JSON files
async function loadContentLinks() {
  try {
    // Load the appropriate JSON file based on media type
    const jsonFile = mediaType === 'tv' ? 'series.json' : 'movies.json';
    const response = await fetch(jsonFile);
    const data = await response.json();
    
    // Find the media item by ID
    const mediaItem = data.movies.find(item => item.id == mediaId);
    
    if (mediaItem) {
      // Set watch button link if stream_link exists
      if (mediaItem.stream_link) {
        document.getElementById('watchBtn').href = mediaItem.stream_link;
      } else {
        document.getElementById('watchBtn').style.display = 'none';
      }
      
      // Set download button behavior
      const downloadBtn = document.getElementById('downloadBtn');
      if (mediaItem.download_links && Object.keys(mediaItem.download_links).length > 0) {
        // If there's only one download link, use it directly
        const downloadLinks = Object.entries(mediaItem.download_links);
        if (downloadLinks.length === 1) {
          downloadBtn.href = downloadLinks[0][1];
        } else {
          // For multiple download options, create a dropdown
          downloadBtn.onclick = (e) => {
            e.preventDefault();
            showDownloadOptions(mediaItem.download_links);
          };
        }
      } else {
        downloadBtn.style.display = 'none';
      }
    } else {
      document.getElementById('watchBtn').style.display = 'none';
      document.getElementById('downloadBtn').style.display = 'none';
    }
  } catch (error) {
    console.error('Error loading content links:', error);
    document.getElementById('watchBtn').style.display = 'none';
    document.getElementById('downloadBtn').style.display = 'none';
  }
}

// Function to show download options dropdown
function showDownloadOptions(downloadLinks) {
  // Remove existing dropdown if any
  const existingDropdown = document.querySelector('.download-dropdown');
  if (existingDropdown) {
    existingDropdown.remove();
    return;
  }
  
  // Create dropdown container
  const dropdown = document.createElement('div');
  dropdown.className = 'download-dropdown';
  dropdown.style.position = 'absolute';
  dropdown.style.backgroundColor = '#1a1a1a';
  dropdown.style.borderRadius = '8px';
  dropdown.style.padding = '10px';
  dropdown.style.boxShadow = '0 4px 15px rgba(0,0,0,0.5)';
  dropdown.style.zIndex = '1000';
  dropdown.style.marginTop = '5px';
  
  // Add download options
  for (const [quality, url] of Object.entries(downloadLinks)) {
    const option = document.createElement('a');
    option.href = url;
    option.className = 'download-option';
    option.style.display = 'block';
    option.style.padding = '8px 15px';
    option.style.color = 'white';
    option.style.textDecoration = 'none';
    option.style.borderRadius = '5px';
    option.style.marginBottom = '5px';
    option.style.backgroundColor = '#2a2a2a';
    option.style.transition = 'background-color 0.2s';
    option.innerHTML = `<i class="bi bi-download"></i> ${quality}`;
    
    option.addEventListener('mouseenter', () => {
      option.style.backgroundColor = '#3a3a3a';
    });
    option.addEventListener('mouseleave', () => {
      option.style.backgroundColor = '#2a2a2a';
    });
    
    dropdown.appendChild(option);
  }
  
  // Position and show dropdown
  const downloadBtn = document.getElementById('downloadBtn');
  const rect = downloadBtn.getBoundingClientRect();
  dropdown.style.left = `${rect.left}px`;
  dropdown.style.top = `${rect.bottom}px`;
  dropdown.style.width = `${rect.width}px`;
  
  document.body.appendChild(dropdown);
  
  // Close dropdown when clicking outside
  const clickHandler = (e) => {
    if (!dropdown.contains(e.target) && e.target !== downloadBtn) {
      dropdown.remove();
      document.removeEventListener('click', clickHandler);
    }
  };
  
  setTimeout(() => {
    document.addEventListener('click', clickHandler);
  }, 0);
}

// Function to filter similar movies to only those available in our collection
async function filterAvailableMedia(mediaItems) {
  try {
    // Load the appropriate JSON file based on media type
    const jsonFile = mediaType === 'tv' ? 'series.json' : 'movies.json';
    const response = await fetch(jsonFile);
    const data = await response.json();
    
    // Get IDs of available media
    const availableIds = data.movies.map(item => item.id.toString());
    
    // Filter similar media to only those we have
    return mediaItems.filter(item => availableIds.includes(item.id.toString()));
  } catch (error) {
    console.error('Error filtering available media:', error);
    return []; // Return empty array if there's an error
  }
}

async function loadMediaDetails() {
  try {
    const response = await fetch(detailsUrl);
    const media = await response.json();

    // Set banner
    const banner = document.getElementById('banner');
    if (media.backdrop_path) {
      banner.style.backgroundImage = `url(https://image.tmdb.org/t/p/original${media.backdrop_path})`;
    } else {
      banner.style.backgroundImage = 'linear-gradient(to right, #1a1a1a, #2a2a2a)';
    }

    // Set poster
    const poster = document.getElementById('poster');
    poster.src = media.poster_path 
      ? `https://image.tmdb.org/t/p/w500${media.poster_path}`
      : 'https://via.placeholder.com/220x330?text=No+Poster';
    poster.alt = mediaType === 'tv' ? media.name : media.title;
    poster.onload = function() {
      this.classList.add('loaded');
    };

    document.getElementById('title').textContent = mediaType === 'tv' ? media.name : media.title;

    // Main tags
    const mainTags = document.getElementById('mainTags');
    mainTags.innerHTML = `
      <div class="tag movie-type">${mediaType === 'tv' ? 'TV Series' : 'Movie'}</div>
      <div class="tag"><i class="bi bi-calendar-event"></i> ${
        mediaType === 'tv'
          ? media.first_air_date ? new Date(media.first_air_date).getFullYear() : 'N/A'
          : media.release_date ? new Date(media.release_date).getFullYear() : 'N/A'
      }</div>
      <div class="tag"><i class="bi ${
        mediaType === 'tv' ? 'bi-collection' : 'bi-clock'
      }"></i> ${
        mediaType === 'tv'
          ? `${media.number_of_seasons} season${media.number_of_seasons !== 1 ? 's' : ''}`
          : media.runtime ? `${Math.floor(media.runtime / 60)}h ${media.runtime % 60}m` : 'N/A'
      }</div>
      <div class="rating-tag"><i class="bi bi-star-fill"></i> ${media.vote_average ? media.vote_average.toFixed(1) : 'N/A'}</div>
    `;

    // Genre tags
    const genreTags = document.getElementById('genreTags');
    genreTags.innerHTML = '';
    if (media.genres && media.genres.length) {
      media.genres.forEach(genre => {
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.textContent = genre.name;
        genreTags.appendChild(tag);
      });
    }

    // Synopsis
    document.getElementById('synopsisText').textContent = media.overview || "No synopsis available.";

    // Load content links from our JSON file
    await loadContentLinks();

  } catch (error) {
    console.error('Error loading media details:', error);
    document.getElementById('title').textContent = 'Error loading content';
    document.getElementById('synopsisText').textContent = 'Failed to load details. Please try again later.';
  }
}

async function loadSimilarMedia() {
  try {
    const response = await fetch(similarUrl);
    const data = await response.json();
    const similarContainer = document.getElementById('similarMovies');
    similarContainer.innerHTML = '';

    if (!data.results || data.results.length === 0) {
      similarContainer.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">No similar content found</p>';
      return;
    }

    // Filter to only show similar media that we have in our collection
    const availableSimilar = await filterAvailableMedia(data.results);
    
    if (availableSimilar.length === 0) {
      similarContainer.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">No similar content available</p>';
      return;
    }

    // Display available similar media (limited to 6)
    availableSimilar.slice(0, 6).forEach(item => {
      const posterPath = item.poster_path 
        ? `https://image.tmdb.org/t/p/w500${item.poster_path}` 
        : 'https://via.placeholder.com/180x270?text=No+Image';
      
      const title = mediaType === 'tv' ? item.name : item.title;
      const releaseDate = mediaType === 'tv' ? item.first_air_date : item.release_date;
      const formattedDate = formatDate(releaseDate);
      const type = mediaType === 'tv' ? 'Series' : 'Movie';
      const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
      const randomQuality = qualityOptions[Math.floor(Math.random() * qualityOptions.length)];
      
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.innerHTML = `
        <div class="poster-wrapper">
          <img class="movie-poster" src="${posterPath}" alt="${title}" onload="this.classList.add('loaded')">
          <div class="rating-star">
            <img src="${starImageUrl}" alt="star">
            ${rating}
          </div>
        </div>
        <div class="movie-info">
          <div class="title">${title}</div>
          <div class="tags">
            <div class="tag">${formattedDate}</div>
            <div class="tag ${randomQuality.class}">${randomQuality.text}</div>
            <div class="tag">${type}</div>
          </div>
        </div>
      `;
      
      // Add click event to redirect to the similar movie's details page
      card.addEventListener('click', () => {
        window.location.href = `movie-detail.html?id=${item.id}&type=${mediaType}`;
      });
      
      similarContainer.appendChild(card);
    });

  } catch (error) {
    console.error('Error loading similar media:', error);
    similarContainer.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">Failed to load similar content</p>';
  }
}

// Helper function to format date (matches index page)
function formatDate(dateString) {
  if (!dateString) return 'Unknown';
  const date = new Date(dateString);
  const options = { month: 'short', day: '2-digit', year: '2-digit' };
  return date.toLocaleDateString('en-US', options);
}

// Load content when page loads
document.addEventListener('DOMContentLoaded', () => {
  if (!mediaId) {
    document.getElementById('title').textContent = 'No content selected';
    document.getElementById('synopsisText').textContent = 'Please go back and select a movie or TV show.';
    return;
  }
  
  loadMediaDetails();
  loadSimilarMedia();
});
</script>
</body>
</html>
